name: Java CI with Maven and Allure

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'

      - name: Cache Maven packages
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Install Allure commandline
        run: |
          sudo apt-get update && sudo apt-get install -y default-jre
          wget https://github.com/allure-framework/allure2/releases/download/2.24.1/allure-2.24.1.tgz
          tar -zxvf allure-2.24.1.tgz
          sudo mv allure-2.24.1 /opt/allure
          sudo ln -s /opt/allure/bin/allure /usr/bin/allure

      - name: Run tests with Maven
        run: mvn clean test

      - name: Generate Allure Report
        run: mvn allure:report

      - name: Upload Allure Report artifact
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: target/site/allure-maven-plugin

  deploy-pages:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Download Allure Report artifact
        uses: actions/download-artifact@v4
        with:
          name: allure-report
          path: ./artifact

      - name: Inspect downloaded artifact (debug)
        run: |
          echo ">>> Listing artifact root:"
          ls -la ./artifact || true
          echo ">>> Listing recursively (max depth 4):"
          find ./artifact -maxdepth 4 -type f -printf "%P\n" || true

      - name: Prepare publish dir from artifact (robust)
        run: |
          set -euo pipefail
          echo "Preparing publish directory..."

          # Clean previous dirs
          rm -rf ./allure-site ./publish
          mkdir -p ./allure-site ./publish

          # 1) If there's a zip file inside artifact, extract the first one found
          ZIPFILE=$(find ./artifact -type f -iname '*.zip' | head -n 1 || true)
          if [ -n "$ZIPFILE" ]; then
            echo "Found ZIP: $ZIPFILE"
            unzip -o "$ZIPFILE" -d ./allure-site
          else
            echo "No zip found. Copying files into ./allure-site"
            # copy everything (handles case where action already extracted the zip)
            cp -r ./artifact/* ./allure-site/ || true
          fi

          echo "After extraction/copy, listing ./allure-site:"
          find ./allure-site -maxdepth 4 -type f -printf "%P\n" || true

          # 2) Locate index.html or nested Allure report folder
          if [ -f "./allure-site/index.html" ]; then
            echo "Found index.html at ./allure-site/index.html — moving to publish/"
            cp -r ./allure-site/* ./publish/
          elif [ -f "./allure-site/target/site/allure-maven-plugin/index.html" ]; then
            echo "Found nested report in target/site/allure-maven-plugin — copying to publish/"
            cp -r ./allure-site/target/site/allure-maven-plugin/* ./publish/
          else
            # try to find any index.html anywhere and copy its parent dir contents
            INDEX_PATH=$(find ./allure-site -type f -iname 'index.html' | head -n 1 || true)
            if [ -n "$INDEX_PATH" ]; then
              echo "Found index at: $INDEX_PATH"
              PARENT_DIR=$(dirname "$INDEX_PATH")
              echo "Copying files from $PARENT_DIR to ./publish/"
              cp -r "$PARENT_DIR"/* ./publish/
            else
              echo "ERROR: no index.html found after extraction. Listing ./allure-site for debugging:"
              find ./allure-site -maxdepth 6 -type f -printf "%P\n" || true
              exit 1
            fi
          fi

          echo "Publish directory prepared. Sample files:"
          ls -la ./publish | sed -n '1,200p' || true

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./publish
          force_orphan: true